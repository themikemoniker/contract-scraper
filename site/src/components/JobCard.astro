---
interface Props {
  job: {
    id: string;
    title: string;
    company: string | null;
    url: string;
    description: string | null;
    tech_stack: string[];
    salary_min: number | null;
    salary_max: number | null;
    salary_currency: string | null;
    salary_type: string | null;
    contract_type: string | null;
    remote_type: string | null;
    location: string | null;
    posted_at: string | null;
    platform: string;
  };
}

const { job } = Astro.props;

function formatSalary(min: number | null, max: number | null, currency: string | null, type: string | null): string {
  if (!min && !max) return '';
  const curr = currency ?? 'USD';
  const suffix = type === 'hourly' ? '/hr' : type === 'yearly' ? '/yr' : '';

  const fmt = (n: number) => {
    if (n >= 1000) return `${Math.round(n / 1000)}k`;
    return String(n);
  };

  if (min && max) {
    return `${curr} ${fmt(min)}-${fmt(max)}${suffix}`;
  }
  return `${curr} ${fmt(min ?? max!)}${suffix}`;
}

function timeAgo(date: string | null): string {
  if (!date) return 'Unknown';
  const seconds = Math.floor((Date.now() - new Date(date).getTime()) / 1000);

  if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;
  if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;
  if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;
  return `${Math.floor(seconds / 604800)}w ago`;
}

const salary = formatSalary(job.salary_min, job.salary_max, job.salary_currency, job.salary_type);
const posted = timeAgo(job.posted_at);

const platformColors: Record<string, string> = {
  hn: '#ff6600',
  jobicy: '#2563eb',
  himalayas: '#8b5cf6',
  wwr: '#16a34a',
};
---

<article class="job-card" data-tech={job.tech_stack.join(',')} data-contract={job.contract_type} data-remote={job.remote_type} data-salary-min={job.salary_min} data-salary-max={job.salary_max} data-salary-type={job.salary_type} data-posted={job.posted_at}>
  <div class="job-header">
    <div class="job-title-row">
      <h3 class="job-title">
        <a href={job.url} target="_blank" rel="noopener noreferrer">
          {job.title}
        </a>
      </h3>
      <span class="platform-badge" style={`background: ${platformColors[job.platform] ?? '#6b7280'}`}>
        {job.platform.toUpperCase()}
      </span>
    </div>
    {job.company && <p class="company">{job.company}</p>}
  </div>

  <div class="job-meta">
    {salary && <span class="meta-item salary">{salary}</span>}
    {job.remote_type && <span class="meta-item remote">{job.remote_type}</span>}
    {job.location && <span class="meta-item location">{job.location}</span>}
    {job.contract_type && <span class="meta-item contract">{job.contract_type}</span>}
    <span class="meta-item time">{posted}</span>
  </div>

  {job.tech_stack.length > 0 && (
    <div class="tech-stack">
      {job.tech_stack.slice(0, 8).map((tech) => (
        <span class="tech-tag">{tech}</span>
      ))}
      {job.tech_stack.length > 8 && (
        <span class="tech-tag more">+{job.tech_stack.length - 8}</span>
      )}
    </div>
  )}

  {job.description && (
    <details class="description">
      <summary>Show description</summary>
      <p>{job.description.slice(0, 500)}{job.description.length > 500 ? '...' : ''}</p>
    </details>
  )}
</article>

<style>
  .job-card {
    background: var(--bg-card);
    border: 1px solid var(--border);
    border-radius: 8px;
    padding: 1.25rem;
    margin-bottom: 1rem;
    transition: box-shadow 0.2s;
  }

  .job-card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
  }

  .job-header {
    margin-bottom: 0.75rem;
  }

  .job-title-row {
    display: flex;
    align-items: flex-start;
    justify-content: space-between;
    gap: 1rem;
  }

  .job-title {
    font-size: 1.125rem;
    font-weight: 600;
    line-height: 1.4;
  }

  .job-title a {
    color: var(--text);
  }

  .job-title a:hover {
    color: var(--primary);
  }

  .platform-badge {
    font-size: 0.625rem;
    font-weight: 600;
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    color: white;
    white-space: nowrap;
  }

  .company {
    color: var(--text-muted);
    font-size: 0.875rem;
    margin-top: 0.25rem;
  }

  .job-meta {
    display: flex;
    flex-wrap: wrap;
    gap: 0.5rem;
    margin-bottom: 0.75rem;
  }

  .meta-item {
    font-size: 0.75rem;
    padding: 0.25rem 0.5rem;
    background: var(--border);
    border-radius: 4px;
    color: var(--text-muted);
  }

  .meta-item.salary {
    background: #dcfce7;
    color: #166534;
  }

  @media (prefers-color-scheme: dark) {
    .meta-item.salary {
      background: #14532d;
      color: #86efac;
    }
  }

  .tech-stack {
    display: flex;
    flex-wrap: wrap;
    gap: 0.375rem;
    margin-bottom: 0.75rem;
  }

  .tech-tag {
    font-size: 0.6875rem;
    padding: 0.125rem 0.375rem;
    background: var(--tag-bg);
    color: var(--tag-text);
    border-radius: 3px;
  }

  .tech-tag.more {
    background: var(--border);
    color: var(--text-muted);
  }

  .description {
    font-size: 0.875rem;
    color: var(--text-muted);
  }

  .description summary {
    cursor: pointer;
    color: var(--primary);
    font-size: 0.8125rem;
  }

  .description p {
    margin-top: 0.75rem;
    white-space: pre-wrap;
    line-height: 1.5;
  }
</style>
